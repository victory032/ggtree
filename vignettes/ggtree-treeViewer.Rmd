---
title: "ggtree: phylogenetic tree viewer and annotator"
author: "Guangchuang Yu <br />
        <guangchuangyu@gmail.com> <br />
        School of Public Health <br />
        The University of Hong Kong"
date: "`r Sys.Date()`"
output: BiocStyle::html_document
vignette: >
  %\VignetteIndexEntry{ggtree: phylogenetic tree viewer and annotator}
  %\VignetteEngine{knitr::rmarkdown}
  %\usepackage[utf8]{inputenc}
---

```{r style, echo=FALSE, results="asis"}
BiocStyle::markdown()
```


> You can't even begin to understand biology, you can't understand life, unless you understand what it's all there for, how it arose - and that means evolution.
> --- Richard Dawkins


## Introduction
This project came out with my needs to annotate nucleotide substitutions in the phylogenetic tree, and I found that there is no tree visualization software can do this easily. All the tree viewer are designed for displaying phylogenetic tree, but not annotating it. Although some tree viewers support displaying bootstrap values in the tree, it is hard/impossible to display other information in the tree. My first solution for displaying nucleotide substituition in the tree is to add these information in the node/tip names and use traditional tree viewer to show it. I displayed the information in the tree successfully, but I do believe this quick-and-dirty hack is ugly.

In the old day, we even don't have enough sequences to infer phylogenetic tree. At that time, as we almost don't have a need to annotate a tree, displaying the evolution relationships is mostly enough. Nowaday, we can obtain a lot of data from different experiments, and we want to associate our data, for instance antigenic change, with the evolution relationship. Visualizing these associations in the phylogenetic tree can help us identify evolution patterns. I believe we need a next generation tree viewer that can view a phylogenetic tree easily as we did with classical software and support adding annotation data in a layer above the tree. This is the objective of developing the `r Githubpkg("GuangchuangYu/ggtree")`. Common tasks of annotating a phylogenetic tree should be easy and complicated tasks can be possible to achieve by adding multiple layers of annotation.

The `r Githubpkg("GuangchuangYu/ggtree")` is designed by extending the `r CRANpkg("ggplot2")` package. It based on grammar of graphics and takes all the good parts of `r CRANpkg("ggplot2")`. There are other R packages that implemented tree viewer using `r CRANpkg("ggplot2")`, including `r CRANpkg("OutbreakTools")`, `r Biocpkg("phyloseq")` and `r Githubpkg("gjuggler/ggphylo")`, but all of them only create complex tree view function for their specific needs. They are just classical tree viewers that only viewing the tree or annotating a specific data type. The good parts of `r CRANpkg("ggplot2")` are not available in these packages. They lack of flexibilities of annotating phylogenetic tree by diverse user inputs. 

## Phylogenetic tree visualization
### Viewing tree with `ggtree`
`r Githubpkg("GuangchuangYu/ggtree")` extend `ggplot` to support viewing phylogenetic tree. It implement `geom_tree` layer for displaying phylogenetic tree, as shown below:
```{r fig.width=6, tidy=TRUE, width=60}
nwk <- system.file("extdata", "sample.nwk", package="ggtree")
print(readLines(nwk))
library(ape)
tree <- read.tree(nwk)
library(ggplot2)
library(ggtree)
ggplot(tree, aes(x, y)) + geom_tree() + theme_tree() + xlab("") + ylab("")
```

The function, `ggtree`, was implemented as a short cut to visualize a tree, and it works exactly the same as shown above.

`ggtree` takes all the advantages of `ggplot2`. For example, we can change the color, size and type of the lines as we did with `ggplot2`.
```{r fig.width=6}
ggtree(tree, color="steelblue", size=1, linetype="dotted")
```

### Support multiple phylogenetic classes

`r Githubpkg("GuangchuangYu/ggtree")` supports several phylogenetic objects including `phylo` (defined by `r CRANpkg("ape")`), `phylo4` (defined by `r CRANpkg("phylobase")`, and `jplace` (defined within `r Githubpkg("GuangchuangYu/ggtree")`).

```{r fig.width=12, fig.height=4}
print(tree)
p1 <- ggtree(tree) + ggtitle("tree of phylo object")
library(phylobase)
tr2 <- as(tree, "phylo4")
str(tr2)
p2 <- ggtree(tr2) + ggtitle("tree of phylo4 object")
jpf <- system.file("extdata", "sample.jplace", package="ggtree")
jp <- read.jplace(jpf)
print(jp)
p3 <- ggtree(jp) + ggtitle("tree of jplace object")
library(gridExtra)
grid.arrange(p1, p2, p3, ncol=3)
```

### Layout

Currently, `ggtree` supports `phylogram` (by default) and `cladogram`.

```{r fig.width=6}
ggtree(tree, layout="cladogram")
```
 
### Display evolution distance

To show evolution distance, we can use `theme_tree2()` or `ggtree(showDistance=TRUE)`

```{r fig.width=6}
ggtree(tree) + theme_tree2()
```

Another way is to show the edge length of the tree: 
```{r fig.width=6, warning=FALSE}
ggtree(tree, showDistance=TRUE) +geom_text(aes(label=length), hjust=1, vjust=-0.5, color="#F06C45")
```

### Display nodes/tips

Show all the internal nodes and tips in the tree can be done by adding a layer of points using `geom_point`.

```{r fig.width=6}
ggtree(tree)+geom_point(aes(shape=isTip, color=isTip), size=3)
```
 
And of course, we can separate nodes and tips by using `subset`.
```{r fig.width=6}
p <- ggtree(tree) + geom_point(subset=.(!isTip), 
     		       	       color="#b5e521", alpha=1/4, size=10)
print(p)
```

```{r fig.width=6}
p + geom_point(color="#FDAC4F", shape=8, size=3, subset=.(isTip))
```

### Display labels
```{r fig.width=6, warning=FALSE}
p + geom_text(aes(label=label), size=6, color="purple", hjust=-0.3)
```


### Tree from right to left
This can be done by reversing the x axis using `scale_x_continuous`.
```{r fig.width=6, fig.height=5}
p + scale_x_continuous(trans="reverse")
```

### Circular phylogenetic tree
Circular form can be done by transoforming the `cartesian` system to `polar` system using `coord_polar`.
```{r fig.width=12, fig.height=6}
require(gridExtra)
tr <- rtree(30)
grid.arrange( ggtree(tr) + coord_polar(theta = "y"), 
	     ggtree(tr, layout="cladogram") + coord_polar(theta="y"),
	     ncol = 2)
```

### Update tree viewing with a new tree
In the __Display nodes/tips__ section, we have a `p` object that stored the tree viewing of 13 tips and internal nodes highlighted with specific colored big dots. If we want to applied this pattern, and we can imaging more complex one, to a new tree, we don't need to build the tree step by step. `r Githubpkg("GuangchuangYu/ggtree")` provides an operator, `%<%`, for applying the visualization pattern to a new tree.

For example, the pattern in the `p` object will be applied to a new tree with 50 tips as shown below:
```{r fig.width=6, fig.height=5}
p %<% rtree(50)
```


## Tree annotation
For tree annotation, please refer to the vignette, [ggtree-treeAnnotation](ggtree-treeAnnotation.html).


## Session Information
```{r}
sessionInfo()
```