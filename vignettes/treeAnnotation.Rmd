---
title: "ggtree: a phylogenetic tree viewer for different types of tree annotations"
author: "Guangchuang Yu <br /> 
	<guangchuangyu@gmail.com> <br /> 
	School of Public Health <br /> 
	Li Ka Shing Faculty of Medicine <br />
	The University of Hong Kong"
date: "`r Sys.Date()`"
output: BiocStyle::html_document
vignette: >
  %\VignetteIndexEntry{ggtree: phylogenetic tree viewer and annotator}
  %\VignetteEngine{knitr::rmarkdown}
  %\usepackage[utf8]{inputenc}
---

```{r style, echo=FALSE, results="asis"}
BiocStyle::markdown()
```


## Tree visualization
For displaying a phylogenetic, please refer to the vignette, [treeViewer](treeViewer.html).


## Tree annotation

```{r fig.width=6, fig.height=5}
nwk <- system.file("extdata", "sample.nwk", package="ggtree")
library(ape)
tree <- read.tree(nwk)
library(ggplot2)
library(ggtree)
p <- ggtree(tree)
```

Suppose we have the following data that associated with the tree and would like to attach the data in the tree.

```{r}
dd <- data.frame(taxa=LETTERS[1:13], 
      		 place=c(rep("GZ", 5), rep("HK", 3), rep("CZ", 4), NA),
                 value=round(abs(rnorm(13, mean=70, sd=10)), digits=1))
## you don't need to order the data
## data was reshuffled just for demonstration
dd <- dd[sample(1:13, 13), ]
row.names(dd) <- NULL
```
```{r eval=FALSE}
print(dd)
```

```{r echo=FALSE, results='asis'}
knitr::kable(dd)
```

We can imaging that the `place` column is the place we isolated the species and `value` column stored numerical values for example bootstrap values.

In [ggtree-treeViewer](ggtree-treeViewer.html), we have shown using the operator, `%<%`, to update a tree view with a new tree. Here, we will introduce another operator, `%<+%`, that attach annotation data to a tree view. The only requirement of the input data is that its first column should be matched with the tip labels of the tree.

After attaching the annotation data to the tree by `%<+%`, all the columns in the data are visible to `ggplot2`. As an example, here we attach the above annotation data to the tree view, `p`, and add a layer that showing the tip labels and colored by the isolation site stored in `place` column.

```{r fig.width=6, fig.height=5, warning=FALSE}
p <- p %<+% dd + geom_text(aes(color=place, label=label), hjust=-0.5)
print(p)
```

We can add another layer to display the isolation sites.
```{r fig.width=6, fig.height=5, warning=FALSE}
p <- p + geom_text(aes(color=place, label=place), hjust=1, vjust=-0.4, size=3)
print(p)
```

And another layer showing numerical values:
```{r fig.width=6, fig.height=5, warning=FALSE}
p <- p + geom_text(aes(color=place, label=value), hjust=1, vjust=1.4, size=3)
print(p)
```

```{r fig.width=7, fig.height=5, warning=FALSE}
p <- p + geom_point(aes(size=value, shape=place, color=place), alpha=0.25, subset=.(isTip))
print(p)
```


## jplace

The `jplace` file format was defined by Masten^[Matsen FA, Hoffman NG, Gallagher A, Stamatakis A (2012) A Format for Phylogenetic Placements. PLoS ONE 7(2): e31009] for phylogenetic placements. We employed this file format to store phylogenetic tree and annotation data. In `r Githubpkg("GuangchuangYu/ggtree")` package, we provides `jplace` class for storing information of jplace file.

Suppose we have a tree, and the associated data that indicate the amino acid substitutions from parent node to child node as shown below:
```{r}
tree <- system.file("extdata", "pa.nwk", package="ggtree")
data <- read.csv(system.file("extdata", "pa_subs.csv", package="ggtree"), stringsAsFactor=FALSE)
print(tree)
head(data)
```

`r Githubpkg("GuangchuangYu/ggtree")` provides a function, `write.jplace`, to combine a tree and an associated data and store them to a single `jplace` file.
```{r eval=FALSE}
write.jplace(tree, data, "pa.jplace")
```

The `read.jplace` function was designed to read the `jplace` file and store the information to a `jplace` object.
```{r}
jpf <- system.file("extdata", "pa.jplace", package="ggtree")
jp <- read.jplace(jpf)
print(jp)
```

The variables of the associated annotation data can be access via `get.fields`.
```{r}
get.fields(jp)
```

Now we know the `jp` object stored the tree and the associated amino acid substitution information, we can view the tree and display the associated annotation data on it directly by `ggtree`.

```{r fig.width=12, fig.height=12, warning=FALSE}
ggtree(jp, showDistance=TRUE) + 
	   geom_text(aes(x=branch, label=subs), color="purple", vjust=-1, size=3) + 
	   geom_text(aes(label=label), hjust=-.5)
```


## Visualize tree and associated matrix
```{r}
nwk <- system.file("extdata", "sample.nwk", package = "ggtree")
require(ape)
tree <- read.tree(nwk)

d <- matrix(sample(1:4, 13*4, replace=T), ncol=4)
row.names(d) <-  tree$tip.label
colnames(d) <- paste0("g", 1:4)
```
```{r eval=FALSE}
print(d)
```

```{r echo=FALSE}
knitr::kable(d)
```

```{r fig.width=12, fig.heigh=6}
gplot(tree, d, low="green", high="red", widths=c(.7, .3))
```

```{r}
d <- matrix(abs(rnorm(13*5)), ncol=5)
row.names(d) <- tree$tip.label
colnames(d) <- paste0("g", 1:5)
```
```{r eval=FALSE}
print(d)
```

```{r echo=FALSE}
knitr::kable(d)
```

```{r fig.width=12, fig.heigh=6}
gplot(tree, d, low="green", high="red", widths=c(.6, .4))
```

## Session info
Here is the output of `sessionInfo()` on the system on which this document was compiled:
```{r echo=FALSE}
sessionInfo()
```
